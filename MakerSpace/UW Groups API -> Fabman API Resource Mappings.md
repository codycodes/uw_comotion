## UW Groups API -> Fabman Resource Mappings

This is a document which contains a mapping of API calls we're using to transform resources between UW Groups API and Fabman's API.

## General Information
### Root URLS
UW Groups API Endpoint:  
https://iam-ws.u.washington.edu/group_sws/v3

Fabman API Endpoint:  
https://fabman.io/api/v1/

### API Docs:
[UW Groups API v3](https://iam-tools.u.washington.edu/apis/gws/)

[Fabman API v1](https://fabman.io/api/v1/documentation#/)

### Accessing API
TODO: adapt this to the language that we're going to use
`curl -u 'token:password' https://fabman.io/api/v1/members`
need to get api token by calling members to get memberId

## Resources


### Getting API token
Have to create it first by POSTing the target member ID to:

POST `/api-keys`

```
{
  "label": "azure-function-12-16-18",
  "member": memberId
}
```

GET `/api-keys/{id}/token` - response back is the token for Fabman
{id} will be given after POSTing

NOTE: API keys donâ€™t expire automatically. If you ever need to invalidate an API key, you can simply delete it.

### Adding members

### Adding members
#### [Add member to UW Group](https://iam-tools.u.washington.edu/apis/gws/#/Membership/putMember)
PUT `/group/{groupid}/member/{memberid}` - Used to put one or multiple members into the UW Group
#### [Add member to Fabman](https://fabman.io/api/v1/documentation#!/members/postMembers)
POST `/members` - Overall JSON data looks like the following. See [Get Members from UW Group and put them into Fabman](#Get-Members-from-UW-Group-and-put-them-into-Fabman) for the actual data we'll be passing in
```
{
  "space": 0,
  "memberNumber": "string",
  "firstName": "string",
  "lastName": "string",
  "gender": "female",
  "dateOfBirth": "2018-12-06",
  "emailAddress": "string",
  "company": "string",
  "phone": "string",
  "address": "string",
  "address2": "string",
  "city": "string",
  "zip": "string",
  "countryCode": "string",
  "region": "string",
  "notes": "string",
  "taxExempt": true,
  "hasBillingAddress": true,
  "requireUpfrontPayment": true,
  "upfrontMinimumBalance": 0,
  "billingFirstName": "string",
  "billingLastName": "string",
  "billingCompany": "string",
  "billingAddress": "string",
  "billingAddress2": "string",
  "billingCity": "string",
  "billingZip": "string",
  "billingCountryCode": "string",
  "billingRegion": "string",
  "billingInvoiceText": "string",
  "metadata": {},
  "id": 0,
  "account": 0,
  "state": "active",
  "stripeCustomer": "string",
  "allowLogin": false,
  "lockVersion": 0,
  "createdAt": "2018-12-06",
  "updatedAt": "2018-12-06",
  "updatedBy": 0
}
```

### Getting Administrators
#### Get UW Groups Administrators
GET `group/uw_comotion_makerspace-admins/effective-members` and `group/uw_comotion_makerspace_staff` as the admin

#### [Get Fabman Administrators](https://fabman.io/api/v1/documentation#!/members/getMembers)
GET `members?privileges=admin` - See (Get Fabman Group)[#Get-Fabman-Group] for examples; just returns the admins inside of Fabman

### Getting Training
GET `/training-courses`

```
[
  {
    "id": training-courses-id,
    "account": accountNumber,
    "title": "Laser Cutter Training",
    "notes": "<div><!--block-->uw_comotion_makerspace_lasercutter</div>",
    "state": "active",
    "lockVersion": 3,
    "createdAt": "2018-12-05T16:35:56.686Z",
    "updatedAt": "2018-12-07T22:26:48.105Z",
    "updatedBy": lastUserWhoUpdated,
    "resources": [
      resources-Id
    ]
  },
  {
    "id": training-courses-id,
    "account": accountNumber,
    "title": "Staff Training",
    "notes": null,
    "state": "active",
    "lockVersion": 1,
    "createdAt": "2018-12-07T22:47:40.717Z",
    "updatedAt": "2018-12-07T22:47:40.717Z",
    "updatedBy": lastUserWhoUpdated,
    "resources": [
      resources-Id
    ]
  },
  {
    "id": training-courses-id,
    "account": accountNumber,
    "title": "Wood Shop Training",
    "notes": null,
    "state": "active",
    "lockVersion": 4,
    "createdAt": "2018-12-07T22:33:46.628Z",
    "updatedAt": "2018-12-07T22:36:00.006Z",
    "updatedBy": lastUserWhoUpdated,
    "resources": [
      resources-Id
    ]
  }
]
```
NOTE: training-courses-id, accountNumber, and resources-Id will be generated by Fabman

### Getting Groups
#### [Get UW Group](https://iam-tools.u.washington.edu/apis/gws/#/Groups/getGroup)
GET `/group/{groupid}` - Gives a lot of information including direct/indirect members and group admins
```
{
  "schemas": [
    "urn:mace:washington.edu:schemas:groups:1.0"
  ],
  "meta": {
    "resourceType": "group",
    "version": "v3.0",
    "regid": "string",
    "id": "string",
    "selfRef": "https://iam-ws.u.washington.edu/group_sws/v3/group/a1681c3fcba3f54f759e6c9432004381",
    "memberRef": "https://iam-ws.u.washington.edu/group_sws/v3/group/a1681c3fcba3f54f759e6c9432004381/member/",
    "timestamp": 1214343146201
  },
  "data": {
    "regid": "a1681c3fcba3f54f759e6c9432004381",
    "name": "u_fox_browser6",
    "displayName": "Fox's test group",
    "description": "This is a general purpose group for testing various Group Service functionality.",
    "created": 1214343146000,
    "lastModified": 1277499258870,
    "lastMemberModified": 1455304388228,
    "contact": "fox",
    "authnfactor": 0,
    "classification": "u",
    "dependsOn": "uw_employee",
    "gid": 12001,
    "affiliates": [
      {
        "name": "google",
        "status": "active"
      }
    ],
    "course": {
      "quarter": "win",
      "year": 2017,
      "curriculum": "phys",
      "number": 121,
      "section": "a",
      "sln": 19029,
      "instructors": [
        {
          "type": "uwnetid",
          "name": "Joe Average",
          "id": "joeuser"
        }
      ]
    },
    "admins": [
      {
        "type": "group",
        "name": "Admins of the zyzz school",
        "id": "x_zyzz_admins"
      }
    ],
    "updaters": [
      {
        "type": "eppn",
        "name": "Ray G. Biv",
        "id": "raybiv@somestate.edu"
      }
    ],
    "creators": [
      {
        "type": "uwnetid",
        "name": "Roy G. Biv",
        "id": "rgbiv99"
      },
      {
        "type": "uwnetid",
        "name": "J. Average",
        "id": "joeuser"
      }
    ],
    "readers": [
      {
        "type": "uwnetid",
        "id": "string",
        "name": "string"
      }
    ],
    "optins": [
      {
        "type": "uwnetid",
        "id": "string",
        "name": "string"
      }
    ],
    "optouts": [
      {
        "type": "uwnetid",
        "id": "string",
        "name": "string"
      }
    ]
  }
}
```
#### [Get Fabman Group] ()
TODO: A fabman group is represented as a group of users which have a certain training.

## Transforms
### Get Members from UW Group and put them into Fabman

#### Uses [Adding members](#adding-members) resources

POST `/members`
```
{
  "space": 0,
  "memberNumber": "UW NETID",
"firstName":"UWNETID",
"emailAddress":"UWNETID@XXX",
  "account": 0
}
```

We can grab the User ID from the response. 

### Adding members as Administrators

TODO: Add getting admins from the specific admin user group -> ### Get Administrators from UW Groups and put them into Fabman. Ensure that we're able to get an email from the UW Group members

This occurs in Fabman:
First create a user in fabman that contains an emailAddress (admins must have email addresses)
POST `/members`
```
{
  "space": 0,
  "memberNumber": "UW NetID",
  "firstName": "UW NetID",
  "emailAddress": "test@domain.com",
  "account":0
}
```
Next we can assign the members privileges in Fabman, effectively making them "admin":
PUT `/members/{id}/privileges`
{id} is the memberId generated by Fabman

```
{
  "privileges": "admin"
}
```

NOTE: Administrators need to have emailAddress if there is no emailAddress then
"message": "Member needs an email address to be admin or owner"

### Get UW Groups' Groups and put them into Fabman
POST `/members/{id}/trainings`
id -> User ID
```
{
  "trainingCourse": ID of the training course
}
```

After created each member, assign them different trainings. 
`uw_comotion_makerspace_lasercutter` will be set pass the training `LaserCutter`. (Note: we need to find the trainingID from Fabman. 
`uw_comotion_makerspace_staff` will be `StaffTraining`.
`uw_comotion_makerspace_woodshop` will be `WoodshopTraining`.

